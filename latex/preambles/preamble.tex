%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% PACKAGE IMPORTS %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% SOME MISC IMPORTS TO DEFINE STUFF FIRST %%%%%
\usepackage{etoolbox}
\usepackage{pgfkeys}

%%%%% FONTS & SYMBOLS %%%%%
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\pgfkeys{
	/ac/.is family, /ac/.cd,
	font/.is choice,
	font/lm/.code={
			\usepackage{lmodern}
			\usepackage{amsfonts,amssymb}
			\providecommand{\tablining}{}
			\providecommand{\propold}{}
			% \renewcommand{\textssc}[1]{\textsc{#1}}
			% \newcommand{\boldsmallcaps}[1]{{\fontfamily{cmr}\textsc{\textbf{#1}}}}
			\usepackage{inconsolata}
		},
	font/mpro/.code={
			\usepackage{MnSymbol}
			\usepackage[
				minionint,
				lf,
				mathtabular,
				loosequotes,
				swash,
				opticals,
				footnotefigures]{MinionPro}
			\providecommand{\tablining}{\figureversion{tab}}
			\providecommand{\propold}{\figureversion{osf}}
			\newcommand{\boldsmallcaps}[1]{\textssc{\textbf{#1}}}
			\usepackage{inconsolata}
		},
	font/lmodern/.code=\pgfkeysalso{font/lm},
	font/minionpro/.code=\pgfkeysalso{font/mpro},
}
\providerobustcmd*{\setfont}[1]{\pgfqkeys{/ac}{#1}}
\usepackage{amsmath}
\usepackage{wasysym}
\usepackage{microtype}

%%%%% GEOMETRY, PAGE SETUP, SPACING, PARAGRAPHING %%%%%
\usepackage[margin=2.5cm,a4paper]{geometry}
\usepackage{titlesec}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{parskip}
\usepackage{tabto}
\usepackage{pdflscape}
\usepackage{enumitem}
\usepackage{adjustbox}
\usepackage[super]{nth}

%%%%% SCIENCE FORMATTING %%%%%
\usepackage{physics}
\usepackage[
	arc-separator = \,,
	retain-explicit-plus,
	%inter-unit-product =\cdot,
	detect-weight=true,
	detect-family=true,
	range-phrase=--,
	range-units=single
]{siunitx}
\usepackage[version=4]{mhchem}
\usepackage[makeroom]{cancel}
\renewcommand{\CancelColor}{\color{red}}

%%%%% GRAPHICS, CAPTIONS, TABLES %%%%%
\usepackage[table,dvipsnames]{xcolor}
\usepackage{graphicx}
\usepackage{float}
\usepackage{tikz,tikz-3dplot}
\usepackage{pgfplots}
\usepackage{pdfpages}
\usepackage[
	justification=centering,
	labelfont={small,bf},
	font={small}
]{caption}
\usepackage{subcaption}
\usepackage{array}
\usepackage{tabularx}
\usepackage{booktabs}
\usetikzlibrary{
	calc,
	arrows,
	arrows.meta,
	positioning,
	decorations.pathreplacing,
	decorations.markings,
	decorations.text,
	calligraphy,
	pgfplots.dateplot
}
\pgfplotsset{compat=1.17}
\usepackage[outline]{contour}
\contourlength{1pt}
\newcommand*\circled[1]{
	\begin{tikzpicture}[baseline=(char.base)]
		\node[shape=circle, draw, minimum size=1.5em, inner sep=0pt, thick] (char) {#1};
	\end{tikzpicture}
}
\tikzset{
	mid arrow/.style={postaction={decorate,decoration={
							markings,
							mark=at position .15 with {\arrow[#1]{stealth}}
						}}},
	>=stealth
}

%%%%% REFERENCES AND LINKS %%%%%
\usepackage{hyperref}
\usepackage[noabbrev]{cleveref}

%%%%% MISCELLANEOUS %%%%%
\usepackage[useregional,calc]{datetime2}
\DTMlangsetup[en-GB]{ord=raise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% MATHS MACROS %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\tomb}{\quad\blacksquare{}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% CREF AND HYPERREF SETUP %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\crefdefaultlabelformat{#2\textbf{#1}#3}

\creflabelformat{equation}{#2\textbf{(#1)}#3}
\creflabelformat{figure}{#2\textbf{#1}#3}

\crefname{equation}{\textbf{equation}}{\textbf{equations}}
\Crefname{equation}{\textbf{Equation}}{\textbf{Equations}}
\crefname{figure}{\textbf{Figure}}{\textbf{Figures}}
\Crefname{figure}{\textbf{Figure}}{\textbf{Figures}}
\crefname{table}{\textbf{Table}}{\textbf{Tables}}
\Crefname{table}{\textbf{Table}}{\textbf{Tables}}
\crefname{appendix}{\textbf{Appendix}}{\textbf{Appendices}}
\Crefname{appendix}{\textbf{Appendix}}{\textbf{Appendices}}
\crefname{section}{\textbf{\S}}{\textbf{\S}}
\Crefname{section}{\textbf{\S}}{\textbf{\S}}
\crefname{algorithm}{\textbf{Algorithm}}{\textbf{Algorithms}}
\Crefname{algorithm}{\textbf{Algorithm}}{\textbf{Algorithms}}

%%%%% SPECIFIC TO EXAM CLASS%%%%%
\creflabelformat{question}{#2\textbf{#1}.#3}
\creflabelformat{partno}{(#2\textbf{#1}#3)}
\creflabelformat{subpart}{(#2\textbf{#1}#3)}

\crefname{question}{question}{questions}
\Crefname{question}{Question}{Questions}
\crefname{partno}{}{}
\Crefname{partno}{}{}
\crefname{subpart}{}{}
\Crefname{subpart}{}{}

\hypersetup{
	colorlinks   = true,            %Colours links instead of ugly boxes
	urlcolor     = NavyBlue,        %Colour for external hyperlinks
	linkcolor    = Magenta,         %Colour of internal links
	citecolor    = Aquamarine       %Colour of citations
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%% EXAM CLASS SETUP %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% CHOICES ON ONE PAGE %%%%%
\BeforeBeginEnvironment{choices}{\par\nopagebreak\minipage{\linewidth}}
\AfterEndEnvironment{choices}{\endminipage}

%%%%% QUESTION/CHOICE LABELS %%%%%
\renewcommand{\questionlabel}{\thequestion.\hfill}
\renewcommand{\subpartlabel}{(\thesubpart)}
\renewcommand{\choicelabel}{\circled{\thechoice}}

%%%%% POINTS FORMATTING %%%%%
\renewcommand{\questionshook}{
	\setlength{\rightpointsmargin}{1.75cm}
	\setlength{\itemsep}{30pt}
}

%%%%% QUESTION/PART/SUBPART INDENTATION %%%%%
\renewcommand{\partshook}{
	\renewcommand\makelabel[1]{\rlap{##1}\hss}
	% \setlength{\itemsep}{6pt}
}

\renewcommand{\subpartshook}{
	\renewcommand\makelabel[1]{\rlap{##1}\hss}
	% \setlength{\itemsep}{6pt}
}

\renewcommand{\choiceshook}{
	\setlength{\labelsep}{10pt}
	\settowidth{\leftmargin}{\circled{W}.\hspace{5pt}\hspace{0em}}
	\setlength{\itemsep}{10pt}
}

\renewcommand{\solutiontitle}{
	\noindent\textbf{Solution:}\par\noindent
}

%%%%% ONEPAR CHOICES SPREAD %%%%%
\patchcmd{\oneparchoices}{\penalty -50\hskip 1em plus 1em\relax}{\hfill}{}{}
\patchcmd{\oneparchoices}{\penalty -50\hskip 1em plus 1em\relax}{\hfill}{}{}

%%%%% SOLUTION ENVIRONMENT %%%%%
\SolutionEmphasis{\color{NavyBlue}}
\correctchoiceemphasis{\color{NavyBlue}\bfseries\boldmath}
\marksnotpoints{}
\pointsinrightmargin{}
\pointsdroppedatright{}
\pointformat{\bfseries\textbf[\themarginpoints]}

%%%%% REDEFINE COVER PAGINATION AS ARABIC %%%%%
\makeatletter
\renewenvironment{coverpages}{%
	\ifnum \value{numquestions}>0\relax
		\ClassError{exam}{%
			Coverpages cannot be used after questions have begun.\MessageBreak
		}{%
			All question, part, subpart, and subsubpart environments
			\MessageBreak
			must begin after the cover pages are complete.\MessageBreak
		}%
	\fi
	\@coverpagestrue
	% \pagenumbering{arabic}%
	\adj@hdht@ftht
	\thispagestyle{headandfoot}
}{%
	\clearpage
	% \setcounter{num@coverpages}{\value{page}}%
	% \addtocounter{num@coverpages}{-1}%
	% \pagenumbering{arabic}%
	% Bugfix, Version 2.307\beta, 2009/06/11:
	% We have to say \@coverpagesfalse before \adj@hdht@ftht
	% because we're still inside the group created by the
	% coverpages environment and we want to set the
	% extraheadheight and extrafootheight to the values correct
	% for the first non-cover page:
	\@coverpagesfalse
	\adj@hdht@ftht
}
\makeatother

%%%%% SHOW 'SOLUTIONS' IN TITLEPAGE IF ANSWERS PRINTED %%%%%
\providerobustcmd*{\printsolntitle}{
	\ifprintanswers{
		\vspace{20pt}
		\fbox{\fbox{\Huge{\textssc{\textbf{\textcolor{red}{solutions}}}}}}
		\vspace{20pt}
	}
	\fi{}
}
\providerobustcmd*{\envupspace}{\ifanswers{\vspace{20pt}}}

%%%%% REMOVE SPACES FROM EnvFullwidth command
\BeforeBeginEnvironment{EnvFullwidth}{\vspace{-10pt}}
\AfterEndEnvironment{EnvFullwidth}{\vspace{-35pt}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%% SIUNITX SETUP %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareSIUnit{\year}{y}
\DeclareSIUnit{\AU}{AU}
\DeclareSIUnit{\parsec}{pc}
\DeclareSIUnit{\lightyear}{ly}
\DeclareSIUnit{\earthmass}{\textit{M}_{\earth}}
\DeclareSIUnit{\jupitermass}{\textit{M}_{J}}
\DeclareSIUnit{\solarmass}{\textit{M}_{\astrosun}}
\DeclareSIUnit{\atm}{atm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%%%%% MISCELLANEOUS %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% SET NUMBERED AND BULLETED LIST MARGIN
\setlist[itemize, 1]{left=0pt}
\setlist[enumerate, 1]{left=0pt,label=\arabic*.}

%%%%% PURPOSE FORGOTTEN %%%%%
\AtBeginEnvironment{tabularx}{
	\tablining
	\sisetup{text-rm={\tablining}}
}

\renewcommand\tabularxcolumn[1]{m{#1}}

\titlelabel{\vspace{-4cm}\thetitle\hspace{10pt}}
\setlength{\jot}{8pt}

%%%%% COPY-PASTABLE PDF %%%%%
\input{glyphtounicode}
\pdfgentounicode=1

%%%%% MICROTYPE SETUP FOR HYPHENATION %%%%%
\pretolerance=2500
\tolerance=4500
\emergencystretch=0pt
\righthyphenmin=4
\lefthyphenmin=4

%%%%% DEFAULT CENTRED FIGURES %%%%%
\AtBeginEnvironment{figure}{\centering}

%%%%% RADIO BUTTONS %%%%%
\makeatletter
\providerobustcmd*{\radiobutton}{%
	\@ifstar{\@radiobutton0}{\@radiobutton1}%
}
\providerobustcmd*{\@radiobutton}[1]{%
	\begin{tikzpicture}
		\pgfmathsetlengthmacro\radius{height("X")/2}
		\draw[radius=\radius] circle;
		\ifcase#1 \fill[radius=.6*\radius] circle;\fi
	\end{tikzpicture}
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% ASTROCHALLENGE SETUP AND MACROS %%%%%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% ASTROCHALLENGE PAPER DATE %%%%%
\providerobustcmd*{\setacpaperdate}[1]{\DTMsavedate{theacpaperdate}{#1}}
\providerobustcmd*{\acpaperdate}{\DTMusedate{theacpaperdate}}

%%%%% ASTROCHALLENGE SMALL CAPS %%%%%
\providecommand{\astrochallenge}{\textbf{\textssc{AstroChallenge \propold\DTMfetchyear{theacpaperdate}}}}

%%%%% AUTOMATIC CATEGORY AND ROUND WITH KEY-VALUE SYSTEM %%%%%
\providebool{ismcq}
\providebool{isteam}
\providebool{isobs}
\providebool{isdaq}

\pgfkeys{
	/ac/.is family, /ac/.cd,
	category/.is choice,
	round/.is choice,
	% DEFINE ACTIONS FOR CATEGORY
	/ac/category/.cd,
	jnr/.code={\edef\category{Junior}},
	snr/.code={\edef\category{Senior}},
	junior/.code=\pgfkeysalso{category/jnr},
	senior/.code=\pgfkeysalso{category/snr},
	% DEFINE ACTIONS FOR CHOICES
	/ac/round/.cd,
	mcq/.code={\edef\round{MCQ}\booltrue{ismcq}},
	team/.code={\edef\round{Team}\booltrue{isteam}},
	obs/.code={\edef\round{Observation}\booltrue{isobs}},
	daq/.code={\edef\round{Data Analysis}\booltrue{isdaq}},
	% ALTERNATIVE NAMES
	MCQ/.code=\pgfkeysalso{round/mcq},
	Team/.code=\pgfkeysalso{round/team},
	Obs/.code=\pgfkeysalso{round/obs},
	DAQ/.code=\pgfkeysalso{round/daq},
}
\providecommand*{\setcatround}[1]{\pgfqkeys{/ac}{#1}}
\providecommand*{\catround}{\textbf{\textssc{\category{} \round{} Round}}}

%%%%% ASTROCHALLENGE TITLING %%%%%
\title{{\Huge\astrochallenge{}}}
\author{\textcopyright \ National University of Singapore Astronomical Society \\
	\textcopyright \ Nanyang Technological University Astronomical Society \\
}

%%%%% ACCESS TITLE COMMANDS %%%%%
\makeatletter
\let\newtitle\@title
\let\newauthor\@author
\makeatother

%%%%% EXAM HEADER/FOOTER SETUP %%%%%
\coverheader{\small{\astrochallenge{}}}{}{\small{\catround{}}}
\header{\small{\astrochallenge{}}}{}{\small{\catround{}}}
\headrule{}

%%%%% PAGE NUMBERING: 'Page X of total' %%%%%
\coverfooter{}{Page \thepage{} of \totalnumpages{}}{\oddeven{\textbf{[Turn over]}}}
\footer{}{Page \thepage{} of \totalnumpages{}}{
	\oddeven{
		\iflastpage{\textbf{[End of paper]}}{\textbf{[Turn over]}}
	}
}

%%%%% ASTROCHALLENGE INSTRUCTIONS: MCQ %%%%%
\providerobustcmd*{\acmcqinst}{
	\begin{enumerate}[itemsep=8pt]
		\item This paper consists of \textbf{\totalnumpages} printed pages, including this cover page.
		\item Do \textbf{NOT} turn over this page until instructed to do so.
		\item You have \textbf{2 hours} to attempt all questions in this paper. If you think there is more than one correct answer, choose the most correct answer.
		\item At the end of the paper, submit this booklet together with your answer script.
		\item Your answer script should clearly indicate your name, school, and team.
		\item It is \textit{your} responsibility to ensure that your answer script has been submitted.
	\end{enumerate}
}

%%%%% ASTROCHALLENGE INSTRUCTIONS: TEAM %%%%%
\providerobustcmd*{\acteaminst}{
	\begin{enumerate}[itemsep=8pt]
		\item This paper consists of \textbf{\totalnumpages} printed pages, including this cover page.
		\item Do \textbf{NOT} turn over this page until instructed to do so.
		\item You have \textbf{2 hours} to attempt all questions in this paper.
		\item At the end of the paper, submit this booklet together with your answer script.
		\item Your answer script should clearly indicate your name, school, and team.
		\item It is your responsibility to ensure that your answer script has been submitted.
		\item The marks for each question are given in brackets in the right margin, like such: \textbf{[2]}.
		\item The \textbf{alphabetical} parts (i) and (l) have been intentionally skipped, to avoid confusion with the Roman numbering of (i).
	\end{enumerate}
}

%%%%% ASTROCHALLENGE INSTRUCTIONS: DAQ %%%%%
\providerobustcmd*{\acdaqinst}{
	In this part of \astrochallenge{}, you will work with a moderately large (approx. \num{4000} points) data set. You will process this data set, analyse it, observe trends, and draw conclusions. \textbf{There are no right or wrong answers}; you will be marked solely on the quality of your analysis, even if your statistical methods are incorrect.\\[8pt]
	We \textbf{strongly} recommend you use industry-standard tools like \texttt{Microsoft Excel}\texttrademark, \texttt{RStudio} or various \texttt{Python} libraries to process the data.\par
}

%%%%% ASTROCHALLENGE INSTRUCTIONS: OBS %%%%%
\providerobustcmd*{\acobsinst}{
	\begin{enumerate}[itemsep=8pt]
		\item This paper consists of \textbf{\totalnumpages} printed pages, including this cover page.
		\item Do \textbf{NOT} turn over this page until instructed to do so.
		\item You have \textbf{1 hour and 30 minutes} to attempt all questions in this paper.
		\item At the end of the paper, submit this booklet together with your answer script.
		\item Your answer script should clearly indicate your name, school, and team.
		\item It is your responsibility to ensure that your answer script has been submitted.
	\end{enumerate}
}

%%%%% ASTROCHALLENGE INSTRUCTIONS %%%%%
\providerobustcmd*{\acinstructions}{
	\ifbool{ismcq}{\acmcqinst}{
		\ifbool{isteam}{\acteaminst}{
			\ifbool{isdaq}{\acdaqinst}{
				\ifbool{isobs}{\acobsinst}{}
			}
		}
	}
}

%%%%% ASTROCHALLENGE INSTRUCTION BOX %%%%%
\providerobustcmd*{\acinstbox}{
	\vspace*{20pt}
	\fbox{
		\fbox{
			\parbox{0.8\textwidth}{
				\vspace*{5pt}
				\begin{center}
					{\large{\textbf{\textssc{please read these instructions carefully.}}}}
				\end{center}
				\vspace*{10pt}

				\acinstructions{}

				\vspace*{5pt}
			}
		}
	}
}

%%%%% ASTROCHALLENGE COVER PAGE %%%%%
\providerobustcmd*{\accoverpage}{
	\begin{coverpages}
		\begin{center}
			\includegraphics[width=0.8\linewidth]{../graphics/misc/logo.jpg}

			\newtitle{}

			{\Huge{\catround{}}}

			\printsolntitle{}

			\acpaperdate{}

			\acinstbox{}

			\vspace*{20pt}

			\newauthor{}
		\end{center}
	\end{coverpages}
}
